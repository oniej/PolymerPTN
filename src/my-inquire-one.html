<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-button-group/paper-button-group.html">
<link rel="import" href="../bower_components/paper-buttons-group/paper-buttons-group.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/datetime-picker/date-picker.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">

<link rel="import" href="time-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-allocation-add.html">
<link rel="import" href="my-allocation-edit.html">

<link rel="import" href="../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>


<link rel="import" href="search-bar.html">
<dom-module id="my-inquire-one">
    <template>
        <style include="shared-styles">
            :host {
                height: 100vh;
                margin: 0;
                display: flex;
                flex-direction: column;
            }

            @-webkit-keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @-moz-keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: darkorange;
            }

            .flex-center-justified {
                @apply --layout-horizontal;
                @apply --layout-center-justified;
                padding: 16px;
            }

            @media (max-width: 420px) {
                .left {
                    margin: 3px;
                    padding: 5px;
                    border-radius: 5px;
                    height: 210px;
                    width: 300px;
                    /* border-style: groove; */
                    background-color: #fff;
                    box-shadow: 0 5px 0 #888888;
                    /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
                }
                .leftcontent {
                    margin: 5px;
                    padding: 2px
                }
                .leftcontent vaadin-combo-box {
                    width: 250px;
                }
                .leftcontent paper-dropdown-input {
                    margin-bottom: 2px;
                    --paper-input-container-underline: {
                        display: none;
                        height: 0;
                    }
                    ;
                    width: 250px;
                    background-color: rgb(230, 230, 230);
                    color: black;
                    height: 50px;
                    border-radius: 4px;
                    --paper-input-container-underline: {
                        display: none;
                        height: 0;
                    }
                    ;
                    --paper-input-container-underline-focus: {
                        display: none;
                    }
                    ;
                    --paper-input-container-input: {
                        box-sizing: border-box;
                        /* font-size: inherit; */
                        padding: 4px;
                        /* margin-bottom:5px; */
                    }
                    --paper-input-container-label: {
                        top: -8px;
                        left: 4px;
                        /* background: white; */
                        padding: 5px;
                        /* font-weight: bold; */
                        border-radius: 10px;
                    }
                    ;
                    --paper-input-container-label-floating: {
                        width: auto;
                    }
                }
             
            }

            @media (min-width: 768px) {
                .left {
                    margin: 5px;
                    padding: 5px;
                    border-radius: 5px;
                    height: 250px;
                    width: 500px;
                    /* border-style: groove; */
                    background-color: #fff;
                    box-shadow: 0 7px 0 #888888;
                    /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
                }
                .leftcontent {
                    margin: 5px;
                    padding: 3px;
                }
                .leftcontent vaadin-combo-box {
                    width: 400px;
                }
               
                .leftcontent paper-dropdown-input {
                    margin-bottom: 5px;
                    --paper-input-container-underline: {
                        display: none;
                        height: 0;
                    }
                    ;
                    width: 400px;
                    background-color: rgb(230, 230, 230);
                    color: black;
                    height: 50px;
                    border-radius: 4px;
                    --paper-input-container-underline: {
                        display: none;
                        height: 5px;
                    }
                    ;
                    --paper-input-container-underline-focus: {
                        display: none;
                    }
                    ;

                    --paper-input-container-label: {
                        top: -8px;
                        left: 4px;
                        /* background: white; */
                        padding: 5px;
                        /* font-weight: bold; */
                        border-radius: 10px;
                    }
                    ;
                    --paper-input-container-label-floating: {
                        width: auto;
                    }
                }
                .leftcontent paper-button {
                    padding: 5px;
                    position: relative;
                    width: 80px;
                    right: -187px;
                    margin-top: 5px;
                    margin-left: 187px;
                }

                vaadin-text-field {
                    width: 130px;
                }

            }

            div .allocation {
                overflow: auto;
                padding: 18px;
                /* width: 90%; */
                margin-bottom: 20px;
                margin: 0 auto;
                background-color: #fff;
                border-radius: 3px;
                /* text-align-last: center; */
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);

                opacity: 0;

                -webkit-animation: fadeIn ease-in 1;
                -moz-animation: fadeIn ease-in 1;
                animation: fadeIn ease-in 1;

                -webkit-animation-fill-mode: forwards;
                -moz-animation-fill-mode: forwards;
                animation-fill-mode: forwards;

                -webkit-animation-duration: 0.5s;
                -moz-animation-duration: 0.5s;
                animation-duration: 0.5s;

            }

            .wrapper {
                display: grid;
            }

            .a {
                grid-column: 1;
            }

            .b {
                grid-column: 2;
            }

            .c {
                grid-column: 3;
            }

            .d {
                grid-column: 4;
            }

            .e {
                grid-column: 5;
            }

            .f {
                grid-column: 6;
            }

            .b .tooltiptext {
                visibility: hidden;
                width: 150px;
                height: auto;
                background-color: rgb(185, 185, 185);
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
                position: absolute;
                z-index: 1;
                bottom: 100%;
                left: 50%;
                margin-left: -80px;
            }

            .b .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 10px;
                border-style: solid;
                border-color: black transparent transparent transparent;
            }

            .b:hover .tooltiptext {
                visibility: visible;
            }

            .c .tooltiptext {
                visibility: hidden;
                width: 250px;
                height: auto;
                background-color: rgb(185, 185, 185);
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
                position: absolute;
                z-index: 1;
                bottom: 100%;
                left: 50%;
                margin-left: -150px;
            }

            .c .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 10px;
                border-style: solid;
                border-color: black transparent transparent transparent;
            }

            .c:hover .tooltiptext {
                visibility: visible;
            }

            .d .tooltiptext {
                visibility: hidden;
                width: 100px;
                height: auto;
                background-color: rgb(185, 185, 185);
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
                position: absolute;
                z-index: 1;
                bottom: 100%;
                left: 50%;
                margin-left: -60px;
            }

            .d .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 10px;
                border-style: solid;
                border-color: black transparent transparent transparent;
            }

            .d:hover .tooltiptext {
                visibility: visible;
            }

            .e .tooltiptext {
                visibility: hidden;
                width: 200px;
                height: auto;
                background-color: rgb(185, 185, 185);
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
                position: absolute;
                z-index: 1;
                bottom: 100%;
                left: 50%;
                margin-left: -100px;
            }

            .e .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 10px;
                border-style: solid;
                border-color: black transparent transparent transparent;
            }

            .e:hover .tooltiptext {
                visibility: visible;
            }

            .searchbtn {
                background-color: blue;
                color: #fff;
            }

            .accordion {
                background-color: #eee;
                color: #444;
                cursor: pointer;
                transition: 0.4s;
            }

            .active,
            .accordion:hover {
                background-color: rgb(255, 255, 255);
            }

            .accordion:after {
                content: '\002B';
                color: rgb(255, 255, 255);

            }

            .active:after {
                content: "\2212";
            }

            .panel {
                padding: 0 18px;
                background-color: white;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
            }
        </style>
        <custom-style>
            <style is="custom-style">
                paper-fab.blue {
                    /* --paper-fab-background: var(--paper-indigo-500); */
                    --paper-fab-background: darkorange;
                    /* --paper-fab-background: var(--paper-light-blue-900); */
                    /* --paper-fab-keyboard-focus-background: var(--paper-light-blue-900); */
                }

                paper-radio-button {
                    --paper-radio-button-label-spacing: 5px;
                    --paper-radio-button-size: 24px;
                }

                paper-radio-button.close {
                    --paper-radio-button-label-color: red;
                }

                paper-radio-button.limited {
                    --paper-radio-button-label-color: yellow;
                }
            </style>
        </custom-style>
        <iron-ajax auto url="/hotel/read" handle-as="json" on-response="_hotelLoaded" debounce-duration="300"></iron-ajax>
        <!-- Availability -->
        <iron-ajax id="available" handle-as="json" method="GET" on-response="_availableloaded"></iron-ajax>
        <!-- allocation -->
        <iron-ajax id="allocate" handle-as="json" method="GET" on-response="_allocateloaded"></iron-ajax>
        <!-- blockings -->
        <iron-ajax id="block" handle-as="json" method="GET" on-response="_blockloaded"></iron-ajax>
        <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="view404" role="main">
            <div name="">
                <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
                    <app-header-layout id="appheader" has-scrolling-region>
                        <app-header fixed slot="header">
                            <app-toolbar>
                                <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
                                <div main-title>Agent Inquiry II</div>
                            </app-toolbar>
                        </app-header>
                        <div class="container flex-center-justified">
                            <div class="left">
                                <div class="leftcontent">
                                    <center>
                                        <iron-icon icon="my-icons:domain" style="color: grey"></iron-icon>&nbsp;
                                        <paper-dropdown-input id="hotel" label="HOTEL" items='[[hotelItems]]' filter-property="hotel" value="{{hotel}}">
                                            <template>
                                                <template is="dom-repeat" items="[[items]]" as="item">
                                                    <paper-item label="[[item.hotel]]">[[item.hotelname]]</paper-item>
                                                </template>
                                            </template>
                                        </paper-dropdown-input>
                                        <br>
                                        <iron-icon icon="my-icons:hotel" style="color: grey"></iron-icon>&nbsp;
                                        <paper-dropdown-input id="room" label="ROOM" items='[[roomele]]' filter-property="room" value="{{room}}">
                                            <template>
                                                <template is="dom-repeat" items="[[items]]" as="item">
                                                    <paper-item label="[[item.room]]">[[item.name]]</paper-item>
                                                </template>
                                            </template>
                                        </paper-dropdown-input>
                                        <br>
                                        <iron-icon icon="my-icons:date-range" style="color: grey"></iron-icon>&nbsp;
                                        <paper-input type="date" placeholder="DATE FROM" id="startdate" value="{{checkin}}" max="{{checkout}}" date-format="DD-MMMM-YYYY"></paper-input>
                                        <br>
                                        <iron-icon icon="my-icons:date-range" style="color: grey"></iron-icon>&nbsp;
                                        <paper-input type="date" placeholder="DATE TO" id="enddate" value="{{checkout}}" min="{{checkin}}" date-format="DD-MMMM-YYYY"></paper-input>
                                    </center>
                                    <paper-button class="searchbtn" raised on-click="SearchBtn">Search</paper-button>
                                </div>
                                <br>
                            </div>
                        </div>
                        <!-- <div>
                            <center>
                                <span id="msg"></span>
                            </center>
                        </div> -->


                        <iron-scroll-document id="threshold">
                            <div class="container flex-center-justified">
                                <div class="allocation" style="background-color: #fff; display: grid;">
                                    <div>
                                        <div>
                                            <vaadin-text-field value="Date" readonly></vaadin-text-field>
                                            <vaadin-text-field value="Hotel" readonly></vaadin-text-field>
                                            <vaadin-text-field value="Room" readonly></vaadin-text-field>
                                            <vaadin-text-field value="Allocation" readonly></vaadin-text-field>
                                            <vaadin-text-field value="Blocking" readonly></vaadin-text-field>
                                            <vaadin-text-field value="Status" readonly></vaadin-text-field>
                                        </div>

                                        <div class="wrapper">
                                            <template is="dom-repeat" items="[[final]]" as="item">
                                                <div class="box a">
                                                    <vaadin-text-field value="[[item.date]]" readonly></vaadin-text-field>
                                                </div>
                                                <div class="box b">
                                                    <vaadin-text-field value="[[item.hotelname]]" readonly></vaadin-text-field>
                                                </div>

                                                <template is="dom-repeat" items="[[item.rooms]]" as="room">
                                                    <div class="box c">
                                                        <vaadin-text-field value="[[room.roomname]]" readonly></vaadin-text-field>
                                                    </div>
                                                    <div class="box d">
                                                        <vaadin-text-field value="[[room.pk]]" readonly></vaadin-text-field>
                                                    </div>
                                                    <div class="box e">
                                                        <vaadin-text-field value="[[room.block]]" readonly></vaadin-text-field>
                                                    </div>
                                                    <div class="box f">
                                                        <vaadin-text-field value="[[room.status]]" readonly></vaadin-text-field>
                                                    </div>
                                                </template>

                                            </template>
                                        </div>
                                    </div>
                                </div>

                        </iron-scroll-document>
                    </app-header-layout>
                </app-drawer-layout>
                </div>
        </iron-pages>
        <iron-ajax verbose id="ajax" method="[[method]]" on-response="_handleResponse"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'my-inquire-one',
            properties: {
                hotelItems: Object,
                roomele: Object,
                hotel: String,
                room: String,
                checkout: String,
                checkin: String,
                availabledata: String,
                allocatedata: String,
                blockdata: String
                // status: String
            },
            observers: [
                '_Searchh(hotel,room,checkin,checkout)',
                '_searchDate(checkin,checkout)',
                '_unionAll(availabledata,allocatedata,blockdata, datefn)'
            ],
            SearchBtn: function () {

            },
            _Searchh(a, b, c, d) {
                a = this.hotel;
                b = this.room;
                // console.log(c);
                var start = new Date(c);
                var checkin = start.getFullYear() + "-" + start.getMonth() + "-" + start.getDay();
                // console.log(start);
                if (a && !b && c && d) {

                    // select * hotel where from =  c  and to = d;
                    // console.log(a);
                    this.$.available.method = 'GET';
                    this.$.available.url = '/availability/filteravail/' + a + "_" + c + "_" + d;
                    this.$.available.generateRequest();

                    this.$.allocate.method = 'GET';
                    this.$.allocate.url = '/allocation/filteralloc/' + a + "_" + c + "_" + d;
                    this.$.allocate.generateRequest();

                    this.$.block.method = 'GET';
                    this.$.block.url = '/blocking/filterblock/' + a + "_" + c + "_" + d;
                    this.$.block.generateRequest();
                }
                else if (!a && b && c && d) {

                    // select * room where from =  c  and to = d;
                    this.$.available.method = 'GET';
                    this.$.available.url = '/availability/filteravailR/' + b + "_" + c + "_" + d;
                    this.$.available.generateRequest();

                    this.$.allocate.method = 'GET';
                    this.$.allocate.url = '/allocation/filterallocR/' + b + "_" + c + "_" + d;
                    this.$.allocate.generateRequest();

                    this.$.block.method = 'GET';
                    this.$.block.url = '/blocking/filterblockR/' + b + "_" + c + "_" + d;
                    this.$.block.generateRequest();
                }
                else if (a && b && c && d) {

                    // select * hotel,room where from =  c  and to = d;
                    this.$.available.method = 'GET';
                    this.$.available.url = '/availability/filteravailF/' + a + "_" + b + "_" + c + "_" + d;
                    this.$.available.generateRequest();

                    this.$.allocate.method = 'GET';
                    this.$.allocate.url = '/allocation/filterallocF/' + a + "_" + b + "_" + c + "_" + d;
                    this.$.allocate.generateRequest();

                    this.$.block.method = 'GET';
                    this.$.block.url = '/blocking/filterblockF/' + a + "_" + b + "_" + c + "_" + d;
                    this.$.block.generateRequest();
                }
                else if (!a && !b && c && d) {

                    // select * from =  c  and to = d;
                    this.$.available.method = 'GET';
                    this.$.available.url = '/availability/filteravailD/' + c + "_" + d;
                    this.$.available.generateRequest();

                    this.$.allocate.method = 'GET';
                    this.$.allocate.url = '/allocation/filterallocD/' + c + "_" + d;
                    this.$.allocate.generateRequest();

                    this.$.block.method = 'GET';
                    this.$.block.url = '/blocking/filterblockD/' + c + "_" + d;
                    this.$.block.generateRequest();
                }
                else { }
            },
            _availableloaded(data) {
                if (data.detail.response.data) {
                    this.availabledata = data.detail.response.data;
                    // console.log(this.availabledata);
                }
            },
            _allocateloaded(data) {
                // console.log(data.detail.response.data);
                if (data.detail.response.data) {
                    this.allocatedata = data.detail.response.data;
                    // console.log(this.allocatedata);
                }
            },
            _blockloaded(data) {
                // console.log(data.detail.response.data);
                if (data.detail.response.data) {
                    this.blockdata = data.detail.response.data;
                    // console.log(this.blockdata);
                }
            },
            _searchDate(x, y) {
                var sdt = Polymer.dom(this.root).querySelector("#startdate");
                var edt = Polymer.dom(this.root).querySelector("#enddate");
                var getDates = function (startDate, endDate) {
                    var dates = [],
                        currentDate = startDate,
                        addDays = function (days) {
                            var date = new Date(this.valueOf());
                            date.setDate(date.getDate() + days);
                            return date;
                        };

                    function convert(date) {
                        var monthNames = [
                            "Jan", "Feb", "Mar",
                            "Apr", "May", "Jun", "Jul",
                            "Aug", "Sep", "Oct",
                            "Nov", "Dec"
                        ];

                        return monthNames[date.getMonth()] + " " + date.getDate() + " " + date.getFullYear()
                    }

                    while (currentDate <= endDate) {
                        dates.push(convert(currentDate));
                        currentDate = addDays.call(currentDate, 1);
                    }
                    return dates;
                };
                var dates = getDates(new Date(sdt.value), new Date(edt.value));

                this.datefn = dates;
            },
            _unionAll(k, l, m, n) {

                if (this.allocatedata && this.blockdata) {
                    function convert(date) {
                        var monthNames = [
                            "Jan", "Feb", "Mar",
                            "Apr", "May", "Jun", "Jul",
                            "Aug", "Sep", "Oct",
                            "Nov", "Dec"
                        ];

                        return monthNames[date.getMonth()] + " " + date.getDate() + " " + date.getFullYear()
                    }
                    var initialArray = [];
                    n.forEach(nEl => {
                        var data = {
                            date: nEl
                        }
                        this.allocatedata.forEach(elAllo => {
                            this.availabledata.forEach(elAvail => {
                                if (elAllo.hotel === elAvail.hotel) {
                                    data.hotelname = elAllo.hotelname;
                                    data.rooms = elAllo.rooms;
                                    data.rooms.forEach(roomEll => {
                                        elAvail.availability.forEach(roomElA => {
                                            if (roomEll.room === roomElA.room && convert(new Date(roomElA.date)) === nEl) {
                                                roomEll.status = roomElA.status;
                                            }
                                        });
                                    });
                                }
                                this.blockdata.forEach(elBlock => {
                                    if (elAllo.hotelname === elBlock.hotelname) {
                                        data.rooms.forEach(roomEl => {
                                            elBlock.rooms.forEach(roomElB => {
                                                if (roomEl.room === roomElB.room) {
                                                    roomEl.block = roomElB.block;
                                                }
                                            });
                                        });
                                    }
                                });
                                initialArray.push(data);
                            });
                        });
                    });

                    // console.log(initialArray);
                    this.final = initialArray;
                }
            },
            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },
            ready() {
                this.url = '/hotel/read';
            },
            _hotelLoaded(data) {
                if (data.detail.response.data) {
                    this.hotelItems = data.detail.response.data;

                    var rooms = [];
                    this.hotelItems.forEach(element => {
                        element.room.forEach(room => {
                            rooms.push(room);
                        });
                    });
                    // console.log(rooms);
                    this.roomele = rooms;
                    // console.log(this.roomele);

                }
            },
            _timeStampToDateTime(ts) {
                return new Date(ts);
            },
        });
    </script>
</dom-module>